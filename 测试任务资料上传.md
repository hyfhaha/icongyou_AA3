# 测试任务资料上传功能

## 测试文件位置

测试文件已创建在 `uploads/materials/` 目录下：
- `test_material_1.pdf`
- `test_material_2.pdf`
- `test_material_3.doc`
- `test_material_4.docx`

**注意**：这些是占位文件（空文件），仅用于测试文件类型验证。要创建真正的可打开文件，请参考 `uploads/materials/测试文件生成指南.md`。

## 快速测试步骤

### 1. 准备真正的测试文件

使用 Microsoft Word 或其他工具创建真正的 PDF 或 DOC/DOCX 文件，然后放到 `uploads/materials/` 目录。

### 2. 测试上传接口

#### 使用 Postman 测试

1. **请求配置**：
   - 方法：`POST`
   - URL：`http://localhost:3000/api/upload/material`
   - Headers：
     ```
     Authorization: Bearer YOUR_TOKEN
     ```
   - Body：
     - 类型：`form-data`
     - Key：`file` (类型选择 `File`)
     - Value：选择 PDF 或 DOC/DOCX 文件

2. **预期成功响应**：
   ```json
   {
     "url": "http://localhost:3000/uploads/materials/a1b2c3d4e5f6g7h8.pdf",
     "filename": "a1b2c3d4e5f6g7h8.pdf",
     "originalname": "test_material_1.pdf",
     "size": 1024,
     "mimetype": "application/pdf"
   }
   ```

3. **测试文件类型限制**：
   - 尝试上传 `.txt` 文件 → 应该返回 400 错误
   - 尝试上传 `.jpg` 文件 → 应该返回 400 错误
   - 上传 `.pdf` 文件 → 应该成功
   - 上传 `.doc` 文件 → 应该成功
   - 上传 `.docx` 文件 → 应该成功

### 3. 验证文件访问

上传成功后，使用返回的 URL 访问文件：
```
GET http://localhost:3000/uploads/materials/{filename}
```

应该能够直接下载或查看文件。

## 测试用例

### 用例1：上传PDF文件 ✅

```bash
curl -X POST http://localhost:3000/api/upload/material \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test_material_1.pdf"
```

**预期结果**：返回成功响应，包含文件URL

### 用例2：上传DOC文件 ✅

```bash
curl -X POST http://localhost:3000/api/upload/material \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test_material_3.doc"
```

**预期结果**：返回成功响应，包含文件URL

### 用例3：上传DOCX文件 ✅

```bash
curl -X POST http://localhost:3000/api/upload/material \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test_material_4.docx"
```

**预期结果**：返回成功响应，包含文件URL

### 用例4：上传不支持的文件类型 ❌

```bash
curl -X POST http://localhost:3000/api/upload/material \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.txt"
```

**预期结果**：返回 400 错误
```json
{
  "message": "任务资料仅支持 PDF 和 DOC/DOCX 格式。当前文件类型: .txt"
}
```

### 用例5：上传超大文件 ❌

上传超过 100MB 的文件

**预期结果**：返回 413 错误
```json
{
  "message": "文件大小超过100MB限制"
}
```

## 前端集成测试

### JavaScript 示例

```javascript
// 测试上传功能
async function testMaterialUpload() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.pdf,.doc,.docx';
  
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch('http://localhost:3000/api/upload/material', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message);
      }
      
      const result = await response.json();
      console.log('✅ 上传成功！');
      console.log('文件URL:', result.url);
      console.log('文件信息:', result);
      
      // 测试文件访问
      window.open(result.url, '_blank');
    } catch (error) {
      console.error('❌ 上传失败:', error.message);
      alert('上传失败: ' + error.message);
    }
  };
  
  fileInput.click();
}

// 调用测试
testMaterialUpload();
```

## 数据库验证

上传成功后，将返回的 URL 存储到数据库：

```sql
-- 插入任务资料记录
INSERT INTO course_map_story_material (
  course_id,
  story_id,
  material_name,
  material_type,
  file_name,
  content,
  creator,
  tenant_id
) VALUES (
  1,  -- course_id
  101, -- story_id
  '需求分析报告模板', -- material_name
  5,  -- material_type (5=文件)
  'test_material_1.pdf', -- file_name
  'http://localhost:3000/uploads/materials/a1b2c3d4e5f6g7h8.pdf', -- content (URL)
  'admin', -- creator
  0   -- tenant_id
);
```

## 常见问题

### Q: 上传后无法访问文件？
A: 检查：
1. 文件是否真的上传到了 `uploads/materials/` 目录
2. 后端静态文件服务是否配置正确（`app.use('/uploads', express.static(...))`）
3. 文件权限是否正确

### Q: 文件类型验证不生效？
A: 检查：
1. 文件扩展名是否正确（`.pdf`, `.doc`, `.docx`）
2. 文件的 MIME 类型是否正确
3. 浏览器是否修改了文件扩展名

### Q: 如何创建真正的PDF/DOC文件？
A: 参考 `uploads/materials/测试文件生成指南.md` 中的详细说明。

